# Прогресс реализации системы фильтров

## Общий статус

| Фаза | Название | Статус | Прогресс |
|------|----------|--------|----------|
| 1 | Модель данных фильтра | `[ ]` | 0% |
| 2 | Query Builder UI | `[ ]` | 0% |
| 3 | Сохранение фильтров | `[ ]` | 0% |
| 4 | Кастомизация колонок | `[ ]` | 0% |
| 5 | Inline редактирование | `[ ]` | 0% |
| 6 | Экспорт данных | `[ ]` | 0% |
| 7 | API фильтры (Atom/JSON) | `[ ]` | 0% |
| 8 | Уведомления об изменениях | `[ ]` | 0% |
| 9 | UI интеграция | `[ ]` | 0% |
| 10 | Виджеты дашборда | `[ ]` | 0% |
| 11 | Программный API | `[ ]` | 0% |
| 12 | Кастомные обработчики | `[ ]` | 0% |
| 13 | Права доступа | `[ ]` | 0% |

---

## Фаза 1: Модель данных фильтра

**Статус:** `[ ]` Не начато
**Приоритет:** P0
**Зависимости:** Нет

### Задачи

- [ ] 1.1 Создать модель `FilterAP` (схема, миграция)
- [ ] 1.2 Создать модель `FilterColumnAP` (конфигурация колонок)
- [ ] 1.3 Добавить адаптеры Sequelize/Waterline
- [ ] 1.4 Добавить связи с UserAP и GroupAP
- [ ] 1.5 Unit тесты для моделей

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 2: Query Builder и замена NodeTable

**Статус:** `[ ]` Не начато
**Приоритет:** P0 (критично)
**Зависимости:** Фаза 1
**Время оценка:** 4 дня

### Контекст трансформации

**Причины замены NodeTable:**
- ❌ Фронтенд мигрирован на @tanstack/react-table, DataTables.js не используется
- ❌ Callback-based архитектура вместо Promise/async-await
- ❌ Не поддерживает операторы из ТЗ (gt, between, in, custom handlers)
- ❌ Только 1 место использования: `src/controllers/list.ts`
- ❌ 0% test coverage

### Задачи

#### Блок A: Трансформация архитектуры (2 дня, выполнять первым)

- [ ] 2.1 Создать ModernQueryBuilder класс (1 день)
  - [ ] 2.1.1 Интерфейс QueryParams (page, limit, sort, filters)
  - [ ] 2.1.2 Метод execute() с Promise API
  - [ ] 2.1.3 Метод buildWhere() для FilterCondition[]
  - [ ] 2.1.4 Метод buildConditionGroup() (рекурсивный AND/OR/NOT)
  - [ ] 2.1.5 Метод buildSingleCondition() для всех операторов
  - [ ] 2.1.6 Метод buildGlobalSearch() (совместимость)
  - [ ] 2.1.7 Метод buildOrder() для сортировки
  - [ ] 2.1.8 Метод mapData() для displayModifier
  - [ ] 2.1.9 Unit тесты с 80%+ покрытием

- [ ] 2.2 Рефакторинг list.ts контроллера (0.5 дня)
  - [ ] 2.2.1 Заменить NodeTable на ModernQueryBuilder
  - [ ] 2.2.2 Упростить построение QueryParams
  - [ ] 2.2.3 Убрать DataTables формат парсинг
  - [ ] 2.2.4 Обновить типы RequestBody
  - [ ] 2.2.5 Integration тесты

- [ ] 2.3 Интеграция с FilterService (0.5 дня)
  - [ ] 2.3.1 FilterService.applyFilter() → ModernQueryBuilder
  - [ ] 2.3.2 Перевод FilterCondition в QueryParams
  - [ ] 2.3.3 Тесты интеграции с реальными фильтрами

- [ ] 2.4 Удалить устаревший NodeTable (0.5 дня)
  - [ ] 2.4.1 Удалить файл `src/lib/datatable/NodeTable.ts`
  - [ ] 2.4.2 Удалить импорты NodeTable
  - [ ] 2.4.3 Обновить документацию
  - [ ] 2.4.4 Создать Migration Guide (если нужно)

#### Блок B: Query Builder функциональность

- [ ] 2.5 Реализовать маппинг операторов (включая ilike, regex)
  - [ ] 2.5.1 Операторы сравнения (eq, neq, gt, gte, lt, lte)
  - [ ] 2.5.2 Операторы строк (like, ilike, startsWith, endsWith)
  - [ ] 2.5.3 Операторы массивов (in, notIn)
  - [ ] 2.5.4 Операторы диапазонов (between)
  - [ ] 2.5.5 Операторы NULL (isNull, isNotNull)
  - [ ] 2.5.6 Regex оператор (для PostgreSQL)

- [ ] 2.6 Добавить поддержку AND/OR/NOT группировки
  - [ ] 2.6.1 Рекурсивная обработка children
  - [ ] 2.6.2 Поддержка NOT логики
  - [ ] 2.6.3 Тесты вложенных условий (глубина 5+)

- [ ] 2.7 Добавить поддержку связей (relations)
  - [ ] 2.7.1 Обработка relation + relationField
  - [ ] 2.7.2 JOIN построение через DataAccessor
  - [ ] 2.7.3 Тесты belongsTo, hasMany связей

- [ ] 2.8 Валидация условий
  - [ ] 2.8.1 Проверка существования полей
  - [ ] 2.8.2 Проверка совместимости оператор-значение
  - [ ] 2.8.3 Рекурсивная валидация групп

- [ ] 2.9 React компонент FilterBuilder
  - [ ] 2.9.1 Интерфейс построения условий
  - [ ] 2.9.2 Добавление/удаление групп
  - [ ] 2.9.3 Выбор операторов по типу поля

- [ ] 2.10 Unit тесты для QueryBuilder
  - [ ] 2.10.1 Тесты buildWhere()
  - [ ] 2.10.2 Тесты buildConditionGroup()
  - [ ] 2.10.3 Тесты buildSingleCondition() для всех операторов
  - [ ] 2.10.4 Тесты buildOrder()
  - [ ] 2.10.5 Тесты mapData()
  - [ ] 2.10.6 Integration тесты execute()

- [ ] 2.11 Валидация безопасности (P0 - критично)
  - [ ] 2.11.1 Определить константы безопасности
  - [ ] 2.11.2 Расширить isValidCondition с проверкой глубины
  - [ ] 2.11.3 Реализовать isFieldAllowed (whitelist полей)
  - [ ] 2.11.4 Реализовать isOperatorValid
  - [ ] 2.11.5 Реализовать validateOperatorValue с лимитами
  - [ ] 2.11.6 Реализовать sanitizeValue для типизации
  - [ ] 2.11.7 Написать тесты безопасности
  - [ ] 2.11.8 Добавить логирование подозрительных попыток

- [ ] 2.12 CustomFieldHandler для сложных полей (P0 - критично)
  - [ ] 2.12.1 Создать класс CustomFieldHandler
  - [ ] 2.12.2 Реализовать регистрацию обработчиков
  - [ ] 2.12.3 Интеграция с ModernQueryBuilder
  - [ ] 2.12.4 Поддержка rawSQL
  - [ ] 2.12.5 Поддержка in-memory фильтрации (Waterline)
  - [ ] 2.12.6 Unit тесты
  - [ ] 2.12.7 Пример для Order.phone (JSON field)

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 3: Сохранение фильтров

**Статус:** `[ ]` Не начато
**Приоритет:** P1
**Зависимости:** Фаза 1, Фаза 2

### Задачи

- [ ] 3.1 CRUD контроллеры для фильтров
- [ ] 3.2 API endpoints (create, update, delete, list)
- [ ] 3.3 Интеграция с UI списка записей
- [ ] 3.4 Загрузка/применение сохранённых фильтров
- [ ] 3.5 Интеграционные тесты
- [ ] 3.6 Миграция и валидация старых фильтров (P1)
  - [ ] 3.6.1 Определить стратегию миграции
  - [ ] 3.6.2 Реализовать валидацию фильтра при загрузке
  - [ ] 3.6.3 Автоматическая конвертация deprecated операторов
  - [ ] 3.6.4 UI для ручной миграции несовместимых фильтров
  - [ ] 3.6.5 Версионирование формата фильтров

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 4: Кастомизация колонок

**Статус:** `[ ]` Не начато
**Приоритет:** P1
**Зависимости:** Фаза 3

### Задачи

- [ ] 4.1 UI для выбора отображаемых полей
- [ ] 4.2 Сохранение конфигурации колонок в фильтре
- [ ] 4.3 Drag-n-drop сортировка колонок
- [ ] 4.4 Ширина колонок (опционально)
- [ ] 4.5 Unit тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 5: Inline редактирование

**Статус:** `[ ]` Не начато
**Приоритет:** P2
**Зависимости:** Фаза 4

### Задачи

- [ ] 5.1 Конфигурация редактируемых полей в модели
- [ ] 5.2 React компоненты inline-редакторов
- [ ] 5.3 Поддержка типов: boolean, string, number, enum
- [ ] 5.4 Валидация и сохранение изменений
- [ ] 5.5 Batch update (множественное редактирование)
- [ ] 5.6 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 6: Экспорт данных

**Статус:** `[ ]` Не начато
**Приоритет:** P1
**Зависимости:** Фаза 3, Фаза 4

### Задачи

- [ ] 6.1 Контроллер экспорта
- [ ] 6.2 JSON экспорт
- [ ] 6.3 CSV экспорт (csv-stringify)
- [ ] 6.4 Excel экспорт (exceljs)
- [ ] 6.5 Применение фильтра и колонок к экспорту
- [ ] 6.6 Streaming для больших данных
- [ ] 6.7 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 7: API фильтры (Atom/JSON)

**Статус:** `[ ]` Не начато
**Приоритет:** P2
**Зависимости:** Фаза 3

### Задачи

- [ ] 7.1 Генерация уникального ключа для фильтра
- [ ] 7.2 JSON API endpoint
- [ ] 7.3 Atom/XML API endpoint
- [ ] 7.4 Пагинация в API
- [ ] 7.5 Rate limiting (опционально)
- [ ] 7.6 Документация API
- [ ] 7.7 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 8: Уведомления об изменениях

**Статус:** `[ ]` Не начато
**Приоритет:** P3
**Зависимости:** Фаза 7, Существующая система уведомлений

### Задачи

- [ ] 8.1 Модель подписки на фильтр
- [ ] 8.2 Интеграция с NotificationService
- [ ] 8.3 Детектор изменений результатов фильтра
- [ ] 8.4 UI подписки/отписки
- [ ] 8.5 Настройки частоты уведомлений
- [ ] 8.6 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 9: UI интеграция

**Статус:** `[ ]` Не начато
**Приоритет:** P2
**Зависимости:** Фаза 3

### Задачи

- [ ] 9.1 Быстрые ссылки в навигации
- [ ] 9.2 Sidebar с сохранёнными фильтрами
- [ ] 9.3 Избранные фильтры
- [ ] 9.4 История последних фильтров
- [ ] 9.5 UI тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 10: Виджеты дашборда

**Статус:** `[ ]` Не начато
**Приоритет:** P2
**Зависимости:** Фаза 3, Существующая система виджетов

### Задачи

- [ ] 10.1 Виджет-счётчик для фильтра
- [ ] 10.2 Конфигурация виджета (цвет, иконка)
- [ ] 10.3 Клик → переход на фильтр
- [ ] 10.4 Auto-refresh счётчика
- [ ] 10.5 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 11: Программный API

**Статус:** `[ ]` Не начато
**Приоритет:** P1
**Зависимости:** Фаза 3

### Задачи

- [ ] 11.1 Класс FilterBuilder для программного создания
- [ ] 11.2 Методы: create, update, delete, find
- [ ] 11.3 Хуки жизненного цикла (beforeCreate, afterUpdate и т.д.)
- [ ] 11.4 Регистрация фильтров через конфиг
- [ ] 11.5 Документация API
- [ ] 11.6 Примеры использования
- [ ] 11.7 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 12: Кастомные обработчики условий

**Статус:** `[ ]` Не начато
**Приоритет:** P3
**Зависимости:** Фаза 2, Фаза 11

### Задачи

- [ ] 12.1 Интерфейс CustomFilterCondition
- [ ] 12.2 Реестр кастомных условий
- [ ] 12.3 Пример: фильтр по метаданным изображения
- [ ] 12.4 Пример: фильтр по JSON полям
- [ ] 12.5 UI для кастомных условий
- [ ] 12.6 Документация
- [ ] 12.7 Тесты

### Заметки

_Добавляйте заметки по ходу работы_

---

## Фаза 13: Права доступа

**Статус:** `[ ]` Не начато
**Приоритет:** P0
**Зависимости:** Фаза 1, Фаза 3

### Задачи

- [ ] 13.1 Личные фильтры (только создатель)
- [ ] 13.2 Публичные фильтры (доступны всем)
- [ ] 13.3 Групповые фильтры (доступны группам)
- [ ] 13.4 Права на редактирование vs просмотр
- [ ] 13.5 Интеграция с AccessRightsHelper
- [ ] 13.6 UI управления правами
- [ ] 13.7 Тесты прав доступа

### Заметки

_Добавляйте заметки по ходу работы_

---

## Блокеры и проблемы

_Документируйте блокирующие проблемы здесь_

| Дата | Проблема | Статус | Решение |
|------|----------|--------|---------|
| - | - | - | - |

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-30 | Создан файл прогресса |
