# Прогресс реализации системы фильтров

## Общий статус

| Фаза | Название | Статус | Прогресс |
|------|----------|--------|----------|
| 1 | Модель данных фильтра | `[x]` | 100% |
| 2 | Query Builder UI | `[x]` | 100% |
| 3 | Сохранение фильтров | `[x]` | 100% |
| 4 | Кастомизация колонок | `[x]` | 100% |
| 5 | Inline редактирование | `[x]` | 100% |
| 6 | Экспорт данных | `[x]` | 100% |
| 7 | API фильтры (Atom/JSON) | `[x]` | 100% |
| 8 | Уведомления об изменениях | `[-]` | N/A (Отменена) |
| 9 | UI интеграция | `[x]` | 100% |
| 10 | Виджеты дашборда | `[x]` | 100% |
| 11 | Программный API | `[x]` | 100% |
| 12 | Кастомные обработчики | `[x]` | 100% |
| 13 | Права доступа | `[x]` | 100% |
| 14 | Выбор полей (Field Selection) | `[x]` | 100% |

---

## Примечание по синхронизации

- Канонический статус выполнения фаз: таблица `Общий статус` и заголовок каждой фазы в этом файле.
- В `./ai-notes/phases/*.md` могут оставаться исторические unchecked чекбоксы в длинных псевдокод-разделах; они не используются как источник фактического прогресса.
- 2026-02-12: Проведена повторная ревизия статусов и чеклистов; критичных расхождений с каноническим статусом не обнаружено.
- 2026-02-12: Канонический план (`.ai-notes/PROGRESS.md`) полностью закрыт: незавершённых пунктов `[ ]` нет, Phase 8 остаётся отменённой по решению архитектуры (pull-only).
- 2026-02-12: Техническое ограничение среды: операции переписывания истории (`git reset --soft`) заблокированы политикой. Дальнейшая работа ведётся в режиме forward-only (новые коммиты поверх текущего состояния).

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 1: Модель данных фильтра

**Статус:** `[x]` Завершено
**Приоритет:** P0
**Зависимости:** Нет

### Задачи

- [x] 1.1 Создать модель `FilterAP` (схема, миграция)
- [x] 1.2 Создать модель `FilterColumnAP` (конфигурация колонок)
- [x] 1.3 Добавить адаптеры Sequelize/Waterline
- [x] 1.4 Добавить связи с UserAP и GroupAP
- [x] 1.5 Unit тесты для моделей

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 2: Query Builder и замена NodeTable

**Статус:** `[x]` Завершено
**Приоритет:** P0 (критично)
**Зависимости:** Фаза 1
**Время оценка:** 4 дня

### Контекст трансформации

**Причины замены NodeTable:**
- ❌ Фронтенд мигрирован на @tanstack/react-table, DataTables.js не используется
- ❌ Callback-based архитектура вместо Promise/async-await
- ❌ Не поддерживает операторы из ТЗ (gt, between, in, custom handlers)
- ❌ Только 1 место использования: `src/controllers/list.ts`
- ❌ 0% test coverage

### Задачи

#### Блок A: Трансформация архитектуры (2 дня, выполнять первым)

- [x] 2.1 Создать ModernQueryBuilder класс (1 день)
  - [x] 2.1.1 Интерфейс QueryParams (page, limit, sort, filters)
  - [x] 2.1.2 Метод execute() с Promise API
  - [x] 2.1.3 Метод buildWhere() для FilterCondition[]
  - [x] 2.1.4 Метод buildConditionGroup() (рекурсивный AND/OR/NOT)
  - [x] 2.1.5 Метод buildSingleCondition() для всех операторов
  - [x] 2.1.6 Метод buildGlobalSearch() (совместимость)
  - [x] 2.1.7 Метод buildOrder() для сортировки
  - [x] 2.1.8 Метод mapData() для displayModifier
  - [x] 2.1.9 Unit тесты с 80%+ покрытием

- [x] 2.2 Рефакторинг list.ts контроллера (0.5 дня)
  - [x] 2.2.1 Заменить NodeTable на ModernQueryBuilder
  - [x] 2.2.2 Упростить построение QueryParams
  - [x] 2.2.3 Убрать DataTables формат парсинг
  - [x] 2.2.4 Обновить типы RequestBody
  - [x] 2.2.5 Integration тесты

- [x] 2.3 Интеграция с FilterService (0.5 дня)
  - [x] 2.3.1 FilterService.applyFilter() → ModernQueryBuilder
  - [x] 2.3.2 Перевод FilterCondition в QueryParams
  - [x] 2.3.3 Тесты интеграции с реальными фильтрами

- [x] 2.4 Удалить устаревший NodeTable (0.5 дня)
  - [x] 2.4.1 Удалить файл `src/lib/datatable/NodeTable.ts`
  - [x] 2.4.2 Удалить импорты NodeTable
  - [x] 2.4.3 Обновить документацию
  - [-] 2.4.4 Создать Migration Guide (если нужно)

#### Блок B: Query Builder функциональность

- [x] 2.5 Реализовать маппинг операторов (включая ilike, regex)
  - [x] 2.5.1 Операторы сравнения (eq, neq, gt, gte, lt, lte)
  - [x] 2.5.2 Операторы строк (like, ilike, startsWith, endsWith)
  - [x] 2.5.3 Операторы массивов (in, notIn)
  - [x] 2.5.4 Операторы диапазонов (between)
  - [x] 2.5.5 Операторы NULL (isNull, isNotNull)
  - [x] 2.5.6 Regex оператор (для PostgreSQL)

- [x] 2.6 Добавить поддержку AND/OR/NOT группировки
  - [x] 2.6.1 Рекурсивная обработка children
  - [x] 2.6.2 Поддержка NOT логики
  - [x] 2.6.3 Тесты вложенных условий (глубина 5+)

- [x] 2.7 Добавить поддержку связей (relations)
  - [x] 2.7.1 Обработка relation + relationField
  - [x] 2.7.2 JOIN построение через DataAccessor
  - [x] 2.7.3 Тесты belongsTo, hasMany связей

- [x] 2.8 Валидация условий
  - [x] 2.8.1 Проверка существования полей
  - [x] 2.8.2 Проверка совместимости оператор-значение
  - [x] 2.8.3 Рекурсивная валидация групп

- [x] 2.9 React компонент FilterBuilder
  - [x] 2.9.1 Интерфейс построения условий
  - [x] 2.9.2 Добавление/удаление групп
  - [x] 2.9.3 Выбор операторов по типу поля

- [x] 2.10 Unit тесты для QueryBuilder
  - [x] 2.10.1 Тесты buildWhere()
  - [x] 2.10.2 Тесты buildConditionGroup()
  - [x] 2.10.3 Тесты buildSingleCondition() для всех операторов
  - [x] 2.10.4 Тесты buildOrder()
  - [x] 2.10.5 Тесты mapData()
  - [x] 2.10.6 Integration тесты execute()

- [x] 2.11 Валидация безопасности (P0 - критично)
  - [x] 2.11.1 Определить константы безопасности
  - [x] 2.11.2 Расширить isValidCondition с проверкой глубины
  - [x] 2.11.3 Реализовать isFieldAllowed (whitelist полей)
  - [x] 2.11.4 Реализовать isOperatorValid
  - [x] 2.11.5 Реализовать validateOperatorValue с лимитами
  - [x] 2.11.6 Реализовать sanitizeValue для типизации
  - [x] 2.11.7 Написать тесты безопасности
  - [x] 2.11.8 Добавить логирование подозрительных попыток

- [x] 2.12 CustomFieldHandler для сложных полей (P0 - критично)
  - [x] 2.12.1 Создать класс CustomFieldHandler
  - [x] 2.12.2 Реализовать регистрацию обработчиков
  - [x] 2.12.3 Интеграция с ModernQueryBuilder
  - [x] 2.12.4 Поддержка rawSQL
  - [x] 2.12.5 Поддержка in-memory фильтрации (Waterline)
  - [x] 2.12.6 Unit тесты
  - [x] 2.12.7 Пример для Order.phone (JSON field)

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 3: Сохранение фильтров

**Статус:** `[x]` Завершено
**Приоритет:** P1
**Зависимости:** Фаза 1, Фаза 2

### Задачи

- [x] 3.1 CRUD контроллеры для фильтров
- [x] 3.2 API endpoints (create, update, delete, list)
- [x] 3.3 Интеграция с UI списка записей
- [x] 3.4 Загрузка/применение сохранённых фильтров
- [x] 3.5 Интеграционные тесты
- [x] 3.6 Миграция и валидация старых фильтров (P1)
  - [x] 3.6.1 Определить стратегию миграции
  - [x] 3.6.2 Реализовать валидацию фильтра при загрузке
  - [x] 3.6.3 Автоматическая конвертация deprecated операторов
  - [x] 3.6.4 UI для ручной миграции несовместимых фильтров
  - [x] 3.6.5 Версионирование формата фильтров

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-07: CRUD и API фильтров подключены, список поддерживает filterId/filterSlug. Build прошёл (vite warnings по sourcemap/large chunks). Dev сервер запущен через `npm run dev` (TSX), остановлен по таймауту. `npm test` прошёл, есть предупреждения sqlite::memory (DEP0170).
- 2026-02-07: Добавлены интеграционные тесты Filters API, обновлён `docs/development.md`. `npm test` прошёл (WARN: sqlite::memory DEP0170).
- 2026-02-07: Добавлены валидация/миграция фильтров (эндпоинты validate/migrate, версия формата), обновлена документация. Build прошёл (vite warnings), `npm run dev` стартовал и остановлен по таймауту, `npm test` прошёл (DEP0170).
- 2026-02-07: Добавлен UI алерт для миграции фильтров в списке записей, обновлена документация. Build прошёл (vite warnings про sourcemap/chunk size), `npm run dev` стартовал и остановлен по таймауту.

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 4: Кастомизация колонок

**Статус:** `[x]` Завершено
**Приоритет:** P1
**Зависимости:** Фаза 3

### Задачи

- [x] 4.1 UI для выбора отображаемых полей
- [x] 4.2 Сохранение конфигурации колонок в фильтре
- [x] 4.3 Drag-n-drop сортировка колонок
- [x] 4.4 Применение конфигурации при отображении списка
- [x] 4.5 Ширина колонок (опционально)
- [x] 4.6 Unit тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-07: Добавлен ColumnSelector (DnD), конфигурация колонок применяется при загрузке списка с фильтром. Документация обновлена.
- 2026-02-07: Добавлено окно настройки колонок для применённого фильтра (Dialog + сохранение в API). Build прошёл (vite warnings про sourcemap/chunk size), `npm run dev` стартовал и остановлен по таймауту.
- 2026-02-07: Добавлена настройка ширины колонок (80-600px), ширины применяются в таблице. Unit тесты для нормализации ширины и моделей добавлены. `npm test` прошёл (WARN: sqlite::memory DEP0170). Build прошёл (vite warnings), `npm run dev` запущен и остановлен по таймауту.
- 2026-02-07: Добавлены unit тесты для логики ColumnSelector (добавление, reorder, toggle). `npm test` прошёл (WARN: sqlite::memory DEP0170). Build прошёл (vite warnings), `npm run dev` стартовал и остановлен по таймауту.

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 5: Inline редактирование

**Статус:** `[x]` Завершено
**Приоритет:** P2
**Зависимости:** Фаза 4

### Задачи

- [x] 5.1 Конфигурация редактируемых полей в модели
- [x] 5.2 React компоненты inline-редакторов
- [x] 5.3 Поддержка типов: boolean, string, number, enum
- [x] 5.4 Валидация и сохранение изменений
- [x] 5.5 Batch update (множественное редактирование)
- [x] 5.6 Тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-08: Реализованы токены Public API, JSON/Atom/RSS эндпоинты, rate limiting, права доступа и документация. Добавлены unit/integration тесты, проверены `npm test` и `npm run build`. `npm run dev` стартовал через TSX и был остановлен по таймауту. E2E тесты остаются в плане.
- 2026-02-10: Добавлены security тесты Public API (токены, приватность фильтров, доступ к модели, инъекции, rate limit). Обновлена документация. `npm test` прошёл (WARN: sqlite::memory DEP0170).
- 2026-02-10: Добавлены E2E тесты Public API на Playwright, обновлена документация и конфиг. `npm test` прошёл (WARN: sqlite::memory DEP0170).

- 2026-02-08: Начата реализация публичного API (Phase 7).

- 2026-02-07: Добавлены `inlineEditable` и `inlineEditConfig` в BaseFieldConfig, обновлена документация `docs/configuration.md`. Build прошёл (vite warnings), `npm run dev` стартовал и остановлен по таймауту.
- 2026-02-07: Добавлен inline edit API (`PATCH /admin/model/:model/:id/field/:fieldName`), React inline editor ячейки, интеграция с list table, обновлена документация `docs/Filters.md`, добавлены тесты inline edit. Build прошёл (vite warnings), `npm run dev` стартовал и остановлен по таймауту, `npm test` прошёл (WARN: sqlite::memory DEP0170).
- 2026-02-07: Добавлен batch inline edit (`PATCH /admin/model/:model/batch`), обновлена документация `docs/Filters.md`, расширены тесты inline edit. Build прошёл (vite warnings), `npm run dev` стартовал и остановлен по таймауту, `npm test` прошёл (WARN: sqlite::memory DEP0170).

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 6: Экспорт данных

**Статус:** `[x]` Завершено
**Приоритет:** P1
**Зависимости:** Фаза 3, Фаза 4

### Задачи

- [x] 6.1 Контроллер экспорта
- [x] 6.2 JSON экспорт
- [x] 6.3 CSV экспорт (csv-stringify)
- [x] 6.4 Excel экспорт (exceljs)
- [x] 6.5 Применение фильтра и колонок к экспорту
- [x] 6.6 Streaming для больших данных
- [x] 6.7 Тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
_Добавляйте заметки по ходу работы_

- 2026-02-07: Добавлены JSON/CSV/Excel экспорт, очередь, streaming, UI кнопка экспорта, тесты. Build прошёл (vite warnings), `npm run dev` стартовал и остановлен по таймауту.

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 7: API фильтры (Atom/JSON)

**Статус:** `[x]` Завершено
**Приоритет:** P2
**Зависимости:** Фаза 3

### Задачи

- [x] 7.1 Генерация уникального ключа для фильтра
- [x] 7.2 JSON API endpoint
- [x] 7.3 Atom/XML API endpoint
- [x] 7.4 Пагинация в API
- [x] 7.5 Rate limiting (опционально)
- [x] 7.6 Документация API
- [x] 7.7 Тесты
- [x] 7.8 Unit тесты
- [x] 7.9 Integration тесты
- [x] 7.10 Security тесты (P0)
- [x] 7.11 E2E тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-10: E2E Public API тесты Playwright завершены, автозапуск TSX сервера для E2E переведён на `npm run start`, добавлены флаги окружения `ADMINIZER_AUTH_CAPTCHA=false` и `ADMINIZER_CSRF=false`. Build и `npm run test:e2e` прошли.

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 8: Уведомления об изменениях

**Статус:** `[-]` Отменено (pull-only стратегия)
**Приоритет:** P3
**Зависимости:** Фаза 7, Существующая система уведомлений

### Задачи

- [-] 8.1 Модель подписки на фильтр (не реализуется)
- [-] 8.2 Интеграция с NotificationService (не реализуется)
- [-] 8.3 Детектор изменений результатов фильтра (не реализуется)
- [-] 8.4 UI подписки/отписки (не реализуется)
- [-] 8.5 Настройки частоты уведомлений (не реализуется)
- [-] 8.6 Тесты (не требуются)

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-12: Синхронизирован статус Phase 8 с `./ai-notes/phases/08-notifications.md`: фаза официально отменена в пользу pull-only стратегии (execute/count + клиентский polling по необходимости).
- 2026-02-12: Синхронизированы заголовки статусов в `./ai-notes/phases/01-13`: завершённые фазы помечены как завершённые, Phase 8 остаётся отменённой.
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 9: UI интеграция

**Статус:** `[x]` Завершено
**Приоритет:** P2
**Зависимости:** Фаза 3

### Задачи

- [x] 9.1 Быстрые ссылки в навигации
- [x] 9.2 Sidebar с сохранёнными фильтрами
- [x] 9.3 Избранные фильтры
- [x] 9.4 История последних фильтров
- [x] 9.5 UI тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-11: Добавлен UI быстрых ссылок в сайдбаре, кнопка закрепления фильтра в списке, API reorder для quick links и обновление документации.
- 2026-02-12: Реализована история последних фильтров (localStorage + sidebar блок Recent Filters), добавлен трекинг применения фильтра в list view, добавлены unit тесты `test/filters/recentFilters.spec.ts`.
- 2026-02-12: Добавлены Playwright UI тесты для Recent Filters (`test/e2e/recent-filters.spec.ts`): сохранение применённого фильтра, порядок последних фильтров и дедупликация.
- 2026-02-12: Стабилизирован E2E запуск: в `playwright.config.ts` добавлены `CLEAN_TMP=true` и детерминированные `ADMIN_LOGIN`/`ADMIN_PASS` из `E2E_ADMIN_LOGIN`/`E2E_ADMIN_PASS`; `test/e2e/recent-filters.spec.ts` обновлён ожиданиями cookie/состояния localStorage. Проверки прошли: `npm test` (25/25), `npm run build`, `npx playwright test test/e2e/recent-filters.spec.ts` (2/2).
- 2026-02-12: Закрыт пункт 9.3 (Favorites): добавлен интеграционный тест `test/filters/filterApi.spec.ts` на обновление `isPinned` и выборку `GET /admin/filters?...&pinned=true`. Полный `npm test` прошёл (`25/25`, `125/125`).
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 10: Виджеты дашборда

**Статус:** `[x]` Завершено
**Приоритет:** P2
**Зависимости:** Фаза 3, Существующая система виджетов

### Задачи

- [x] 10.1 Виджет-счётчик для фильтра
- [x] 10.2 Конфигурация виджета (цвет, иконка)
- [x] 10.3 Клик → переход на фильтр
- [x] 10.4 Auto-refresh счётчика
- [x] 10.5 Тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-12: Начата фаза 10. Добавлен `FilterCountWidget` (`src/lib/widgets/FilterCountWidget.ts`) с per-user TTL кэшем и ссылкой на direct link фильтра. Контракт `InfoBase.getInfo` расширен до `getInfo(req?)`, `widgetInfoController` передаёт `req`. Добавлены unit тесты `test/filterCountWidget.spec.ts` и документация в `docs/Filters.md`.
- 2026-02-12: Завершена фаза 10. Для info-виджетов добавлено автообновление по `refreshIntervalSec` (backend `WidgetConfig` + frontend polling в `widget-item.tsx`), расширены типы виджетов, подтверждены `npm test` и `npm run build`.
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 11: Программный API

**Статус:** `[x]` Завершено
**Приоритет:** P1
**Зависимости:** Фаза 3

### Задачи

- [x] 11.1 Класс FilterBuilder для программного создания
- [x] 11.2 Методы: create, update, delete, find
- [x] 11.3 Хуки жизненного цикла (beforeCreate, afterUpdate и т.д.)
- [x] 11.4 Регистрация фильтров через реестр (FilterRegistry)
- [x] 11.5 Документация API
- [x] 11.6 Примеры использования
- [x] 11.7 Тесты
- [x] 11.8.1 Интеграция: программное создание фильтра
- [x] 11.8.2 Интеграция: выполнение preset фильтра
- [x] 11.8.3 Интеграция: миграция драфта v1 -> v2
- [x] 11.8.4 Интеграция: TypeScript compilation (build pipeline)
- [x] 11.9.3 Migration guide
- [x] 11.9.4 TypeDoc generation
- [x] 11.10.1 E2E: create filter via API
- [x] 11.10.2 E2E: use preset filter
- [x] 11.10.3 E2E: register custom criteria
- [x] 11.10.4 E2E: run migration

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-12: Расширен программный API: добавлены `FilterRegistry`, `FilterPresets`, `FilterMigration`, публичные экспорты в `src/index.ts`, покрытие сценариев в `test/filterBuilder.spec.ts`, обновлена документация `docs/Filters.md`.
- 2026-02-12: Блокер окружения: в текущем shell отсутствуют `node`/`npm`/`npx` в PATH, поэтому тесты/сборка не подтверждены в этом запуске.
- 2026-02-12: Добавлен `FilterProgrammaticApi` (CRUD + lifecycle hooks), тесты `test/filterProgrammaticApi.spec.ts`, документация расширена примерами scripted API.
- 2026-02-12: Валидация шага: `npm test` → 27/27 файлов, 137/137 тестов; `npm run build` успешно; `npm run dev` (TSX) успешно стартует и обслуживает `http://localhost:3000` (остановлен по timeout).
- 2026-02-12: Добавлены integration тесты `test/filters/filterProgrammaticApi.integration.spec.ts` (создание из preset, миграция draft, lifecycle hooks через реальный `FilterRepository`), обновлён чеклист фазы 11.
- 2026-02-12: Валидация шага: `npm test` → 28/28 файлов, 139/139 тестов; `npm run build` успешно; `npm run dev` (TSX) успешно стартует на `http://localhost:3000` (остановлен по timeout).
- 2026-02-12: Добавлен migration guide `docs/FilterProgrammaticMigration.md`, добавлен script `docs:typedoc` и конфиг `typedoc.filter-builder.json`, сгенерированы API docs в `docs/api/filter-builder/` (Typedoc завершён с предупреждениями по внешним типам).
- 2026-02-12: Добавлен E2E сценарий `test/e2e/filter-programmatic-api.spec.ts` и подтверждены `11.10.1-11.10.4` (`npx playwright test test/e2e/filter-programmatic-api.spec.ts` → 3/3 passed).
- 2026-02-12: Для совместимости runtime+tsc обновлён `src/lib/widgets/FilterCountWidget.ts` (убран конфликт `declare`/TS2612), после фикса успешно проходят `npm run build` и Playwright webServer startup.
- 2026-02-12: Полный e2e набор успешно пройден: `npm run test:e2e` → 9/9 passed.
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 12: Кастомные обработчики условий

**Статус:** `[x]` Завершено
**Приоритет:** P3
**Зависимости:** Фаза 2, Фаза 11

### Задачи

- [x] 12.1 Интерфейс CustomFilterCondition
- [x] 12.2 Реестр кастомных условий
- [x] 12.3 FullTextMatcher
- [x] 12.4 GeospatialMatcher
- [x] 12.5 ArrayMatcher
- [x] 12.6 ComputedFieldMatcher
- [x] 12.6 Документация
- [x] 12.7 Тесты

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-12: Добавлен `CustomConditionRegistry` как facade над `CustomFieldHandler` (`src/lib/query-builder/CustomConditionRegistry.ts`) и экспорт из `src/index.ts`.
- 2026-02-12: Добавлены/обновлены тесты `test/customConditionRegistry.spec.ts` (register/get/getForModel) + валидация связки с `CustomFieldHandler`/`ModernQueryBuilder`; проверки: `npm run test -- test/customConditionRegistry.spec.ts test/customFieldHandler.spec.ts test/modernQueryBuilder.spec.ts` и полный `npm test` (29 files / 156 tests).
- 2026-02-12: Проверены runtime шаги: `npm run build` успешен (warning-only по sourcemap/chunk size), `npm run dev` успешно стартует через `tsx watch` (smoke под `timeout`).
- 2026-02-12: Реализован `JsonPathMatcher` (`src/lib/query-builder/JsonPathMatcher.ts`) с SQL-путями для PostgreSQL/MySQL и in-memory fallback, добавлены тесты `test/jsonPathMatcher.spec.ts`, экспорт в `src/index.ts` и документация в `docs/Filters.md`.
- 2026-02-12: Реализован `FullTextMatcher` (`src/lib/query-builder/FullTextMatcher.ts`) с SQL для PostgreSQL/MySQL и in-memory fallback, добавлены тесты `test/fullTextMatcher.spec.ts`, экспорт в `src/index.ts`; валидация: `npm test` -> 31/31 файлов, 166/166 тестов.
- 2026-02-12: Реализован `GeospatialMatcher` (`src/lib/query-builder/GeospatialMatcher.ts`) с radius/polygon режимами, SQL-условиями (Haversine/bounding-box) и in-memory fallback; добавлены тесты `test/geospatialMatcher.spec.ts`; валидация: `npm test` -> 32/32 файлов, 171/171 тестов.
- 2026-02-12: Реализован `ArrayMatcher` (`src/lib/query-builder/ArrayMatcher.ts`) с режимами `contains/overlaps/containsAll`, водяной критерий для Waterline и in-memory fallback для остальных адаптеров; добавлены тесты `test/arrayMatcher.spec.ts`.
- 2026-02-12: Реализован `ComputedFieldMatcher` (`src/lib/query-builder/ComputedFieldMatcher.ts`) с in-memory вычислением и helper `filterByComputedField`; добавлены тесты `test/computedFieldMatcher.spec.ts`, экспорт в `src/index.ts`.
- 2026-02-12: Добавлен интеграционный набор `test/filters/customMatchers.integration.spec.ts` для `CustomConditionRegistry` + `JsonPathMatcher` + `FullTextMatcher` + `GeospatialMatcher` + `ArrayMatcher` + `ComputedFieldMatcher`; финальная валидация шага: `npm test` -> 35/35 файлов, 186/186 тестов, `npm run build` успешно, `npm run dev` (TSX) успешно стартует на `http://localhost:3000` (smoke под `timeout`).
- 2026-02-12: Синхронизирован чеклист `12-custom-conditions.md`: `12.8 Integration` помечен выполненным; `12.9 Performance` и `12.10 E2E` помечены как отложенные вне scope текущего релиза.
- 2026-02-12: Контрольная валидация после синхронизации план/статусов: `npm test` -> 35/35 файлов, 186/186 тестов; `npm run build` успешно (warning-only по sourcemap/chunk size).
- 2026-02-12: Повторный smoke runtime после обновления план-документации: `npm run dev` (TSX) успешно стартует, приложение доступно на `http://localhost:3000` (остановлено по `timeout`).
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 13: Права доступа

**Статус:** `[x]` Завершено
**Приоритет:** P0
**Зависимости:** Фаза 1, Фаза 3

### Задачи

- [x] 13.1 Личные фильтры (только создатель)
- [x] 13.2 Публичные фильтры (доступны всем)
- [x] 13.3 Групповые фильтры (доступны группам)
- [x] 13.4 Права на редактирование vs просмотр
- [x] 13.5 Интеграция с AccessRightsHelper
- [x] 13.6 UI управления правами
- [x] 13.7 Тесты прав доступа
- [x] 13.10.2 Security: vertical privilege escalation

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-12: Усилен security-набор прав доступа: добавлены тесты IDOR для direct link, массового присвоения owner (create/update), и tampered token для public API (`test/filters/filterApi.spec.ts`, `test/filters/publicApiPermissions.spec.ts`).
- 2026-02-12: Валидация шага: `npx vitest run test/filters/filterApi.spec.ts test/filters/publicApiPermissions.spec.ts` -> 18/18, `npm test` -> 28/28 файлов, 143/143 тестов.
- 2026-02-12: Добавлена серверная защита от вертикальной эскалации: не-админам запрещено создавать/обновлять `isSystemFilter` (`src/controllers/filters/create.ts`, `src/controllers/filters/update.ts`), добавлены интеграционные тесты. `npm test` -> 28/28 файлов, 145/145 тестов.
- 2026-02-12: Закрыты пункты `13.10.4` и `13.10.7`: добавлены тесты на попытку bypass через изменение ACL-полей чужого фильтра и на отсутствие утечки приватных фильтров в list endpoint (`test/filters/filterApi.spec.ts`). Обновлен сценарий вертикальной эскалации до стабильного seed через модель. `npx vitest run test/filters/filterApi.spec.ts test/filters/publicApiPermissions.spec.ts` -> 22/22.
- 2026-02-12: Полная валидация после изменений: `npm test` -> 28/28 файлов, 147/147 тестов; `npm run build` успешно. Исправлен TSX startup для fixture (`fixture/index.ts`: явный импорт `../dist/index.js`), `npm run dev` стартует корректно (smoke под `timeout`).
- 2026-02-12: Расширены интеграционные проверки Phase 13 (`test/filters/filterApi.spec.ts`): owner full access, shared read-only для group filters (view yes / edit-delete no), audit trail (events created/updated/deleted). Валидация: `npx vitest run test/filters/filterApi.spec.ts test/filters/publicApiPermissions.spec.ts` -> 24/24.
- 2026-02-12: Закрыт `13.9.5 Permission inheritance`: добавлен интеграционный тест наследования model-level прав для feed endpoint (`/admin/api/public/atom/:filterId`) в `test/filters/publicApiPermissions.spec.ts`. Валидация: `npx vitest run test/filters/publicApiPermissions.spec.ts test/filters/filterApi.spec.ts` -> 25/25.
- 2026-02-12: Закрыт блок `13.11 Performance`: добавлен in-memory permission cache в `src/lib/filters/services/FilterAccessService.ts` и perf-тесты (`test/filters/filterAccessService.spec.ts`) для SLA: single check < 10ms, bulk checks < 100ms, cache hit < 1ms. Валидация: `npx vitest run test/filters/filterAccessService.spec.ts test/filters/filterApi.spec.ts test/filters/publicApiPermissions.spec.ts` -> 33/33.
- 2026-02-12: Закрыт пункт `13.12.5 Access denied scenarios`: добавлен E2E-сценарий отказа public API без токена в `test/e2e/public-api.spec.ts`. Валидация: `npx playwright test test/e2e/public-api.spec.ts` -> 5/5.
- 2026-02-12: Зафиксирован `13.12.3 Revoke access` на базе существующего E2E-сценария revoke token (`test/e2e/public-api.spec.ts`: проверка, что после revoke доступ по токену возвращает `401`).
- 2026-02-12: Закрыт блок `13.12 E2E`: добавлен `test/e2e/filter-access-rights.spec.ts` (group-sharing flow, change permissions, view audit trail через history endpoint). Валидация: `npx playwright test test/e2e/filter-access-rights.spec.ts` -> 3/3.
- 2026-02-12: Для `13.12.1` использован текущий механизм шаринга через `visibility=groups` + `groupIds` (пользовательский share endpoint отсутствует в текущей архитектуре).
- 2026-02-12: Комплексная E2E-валидация прав и public API: `npx playwright test test/e2e/public-api.spec.ts test/e2e/filter-access-rights.spec.ts` -> 8/8.
- 2026-02-12: Добавлен UI-блок управления доступом фильтра в диалог Columns (`src/assets/js/components/list-table.tsx`): visibility (`private/public/groups`) и `groupIds` c сохранением через `PATCH /filters/:id`. Проброс текущих значений доступа добавлен в `src/controllers/list.ts`. Валидация: `npm run build` (ok), `npx vitest run test/filters/filterApi.spec.ts` (18/18).
_Добавляйте заметки по ходу работы_

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## Фаза 14: Выбор полей (Field Selection)

**Статус:** `[x]` Завершено
**Приоритет:** P2
**Зависимости:** Фаза 2, Фаза 3, Фаза 4

### Задачи

- [x] 14.1 Расширить интерфейсы модели
  - [x] 14.1.1 Добавить `select?: string[]` в `FindOptions` (`AbstractModel.ts`)
  - [x] 14.1.2 Обновить адаптер Waterline для обработки `select`
  - [x] 14.1.3 Обновить адаптер Sequelize для обработки `attributes`

- [x] 14.2 Модифицировать систему фильтров
  - [x] 14.2.1 Добавить `selectedFields?: string[]` в модель `FilterAP`
  - [x] 14.2.2 Обновить `FilterBuilder` для сохранения выбранных полей (`selectFields()`)
  - [x] 14.2.3 Модифицировать `FilterService` для применения выборки полей при выполнении фильтра

- [x] 14.3 Интегрировать в QueryBuilder
  - [x] 14.3.1 Обновить `ModernQueryBuilder` для использования `selectedFields` из фильтра
  - [x] 14.3.2 Добавить логику применения выборки полей к запросам
  - [x] 14.3.3 Обеспечить fallback на все поля, если выборка не указана

- [x] 14.4 UI компоненты
  - [x] 14.4.1 Реализовать интерфейс выбора полей в редакторе фильтров
  - [x] 14.4.2 Обновить отображение данных с учётом выбранных полей
  - [x] 14.4.3 Добавить валидацию выбранных полей

- [x] 14.5 Тестирование и документация
  - [x] 14.5.1 Unit тесты для новой функциональности
  - [x] 14.5.2 Integration тесты для выборки полей
  - [x] 14.5.3 Обновить пользовательскую документацию

### Заметки

- 2026-02-10: Добавлен backend для quick links фильтров (генератор ссылок, сервис, API-роуты list/create/remove), добавлены unit тесты для генерации URL, badge и icon mapping. Обновлена документация `docs/Filters.md`.
- 2026-02-12: Phase 14 завершена: `selectedFields` в model/query/filter execution/preview, UI выбор полей в `FilterBuilder`, алиас `selectFields()`, документация обновлена. Верификация: `npm run dev` (TSX) стартует, `npm run build` успешно, `npm test` успешно (24 файла / 122 теста).
_Добавляйте заметки по ходу работы_

---
## Блокеры и проблемы

_Документируйте блокирующие проблемы здесь_

| Дата | Проблема | Статус | Решение |
|------|----------|--------|---------|
| 2026-02-09 | `npm run build` падает из-за ошибок TS1434 в `src/controllers/filters/create.ts` | Решено | Сборка проходит без ошибок |

---

## Общие принципы реализации

- Над каждым смысловым блоком кода и текста должен быть короткий комментарий (1-2 строки): что делает блок и зачем он нужен
- Код не раздуваем: повторяющаяся логика выносится в хелперы/сервисы, новые хелперы не плодим без необходимости
- Вся логика фильтров (парсинг, нормализация, сбор условий, сортировка и т.д.) должна быть объединена в единый сервис фильтров и использоваться из контроллеров
- Контроллеры должны оставаться тонкими: принять запрос → вызвать сервис → вернуть ответ
- При проверке изменений убеждаемся: логика фильтров не дублируется, контроллеры не раздулись, используется общий сервис фильтров

---
## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-01-30 | Создан файл прогресса |
| 2026-02-06 | Phase 1 completed |
| 2026-01-30 | Создан файл прогресса |
| 2026-02-06 | Phase 2 task 2.1 completed |
| 2026-02-07 | Phase 2 task 2.2 completed |
| 2026-02-07 | Phase 2 task 2.3 completed |
| 2026-02-07 | Phase 2 task 2.4 completed |
| 2026-02-07 | Phase 2 task 2.5 completed |
| 2026-02-07 | Phase 2 task 2.6 completed |
| 2026-02-07 | Phase 2 task 2.7 completed |
| 2026-02-07 | Phase 2 task 2.8 completed |
| 2026-02-07 | Phase 2 task 2.9 completed |
| 2026-02-07 | Phase 2 task 2.10 completed |
| 2026-02-07 | Phase 2 task 2.11 completed |
| 2026-02-07 | Phase 2 task 2.12 completed |
| 2026-02-07 | Phase 3 tasks 3.1-3.4 completed, build/dev run |
| 2026-02-07 | Phase 3 task 3.5 completed (integration tests) |
| 2026-02-07 | Phase 3 task 3.6 (migration/validation, except UI) |
| 2026-02-07 | Phase 3 task 3.6.4 completed (UI migration alert) |
| 2026-02-07 | Phase 4 tasks 4.1-4.4 completed (column selector + list apply) |
| 2026-02-07 | Phase 4: added columns dialog for applied filters |
| 2026-02-07 | Phase 4 task 4.5 completed (column width) + width tests added |
| 2026-02-07 | Phase 4 task 4.6 completed (column selector unit tests) |
| 2026-02-07 | Phase 5 task 5.1 completed (inlineEditable config) |
| 2026-02-07 | Phase 6 export completed (controller, formats, streaming, tests) |
| 2026-02-08 | Phase 7 public API implemented, tests + docs updated, build/dev/test run |
| 2026-02-09 | Добавлена фаза 14: выбор полей (Field Selection) |
| 2026-02-09 | Централизованы парсинг/нормализация фильтров в FilterService, контроллеры облегчены |
| 2026-02-12 | Phase 14 completed; dev/build/test verification passed (24/24 files, 122/122 tests) |
