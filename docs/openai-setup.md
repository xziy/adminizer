# Настройка OpenAI API для Adminizer

## Обзор

Adminizer поддерживает интеграцию с OpenAI API для функциональности AI-ассистента. Эта интеграция позволяет системе отвечать на вопросы пользователей, используя данные из моделей Adminizer.

## Конфигурация

### Переменные окружения

Для работы OpenAI интеграции необходимо настроить следующие переменные окружения:

#### Обязательные переменные

- `OPENAI_API_KEY` - Основной API ключ OpenAI
- `ADMINIZER_OPENAI_KEY` - Альтернативный API ключ (резервный)

#### Дополнительные переменные

- `OPENAI_AGENT_MODEL` - Модель OpenAI для использования (по умолчанию: `gpt-4.1-mini`)

### Настройка .env файла

1. Создайте файл `.env` в корне проекта:
```bash
# OpenAI API Configuration
OPENAI_API_KEY=your_openai_api_key_here

# Optional: Alternative key (fallback)
ADMINIZER_OPENAI_KEY=your_alternative_key_here

# Optional: Model configuration
OPENAI_AGENT_MODEL=gpt-4.1-mini
```

2. Убедитесь, что файл `.env` добавлен в `.gitignore` для безопасности.

### Получение API ключа

1. Перейдите на [OpenAI Platform](https://platform.openai.com/api-keys)
2. Создайте новый API ключ
3. Скопируйте ключ и добавьте его в файл `.env`

## Архитектура

### OpenAiDataAgentService

Основной класс `OpenAiDataAgentService` наследуется от `AbstractAiModelService` и обеспечивает:

- Проверку наличия API ключа
- Создание агента OpenAI с инструментом для запроса данных
- Обработку истории сообщений
- Интеграцию с системой прав доступа Adminizer

### Возможности агента

- **Запрос данных модели**: Агент может запрашивать данные из любых моделей Adminizer, доступных пользователю
- **Фильтрация**: Поддержка JSON-фильтров для точного поиска данных
- **Проекция полей**: Возможность указать конкретные поля для возврата
- **Ограничение результатов**: Контроль количества возвращаемых записей
- **Проверка прав**: Автоматическая проверка прав доступа пользователя к моделям

### Конфигурация в adminizerConfig.ts

```typescript
const config: AdminpanelConfig = {
    aiAssistant: {
        enabled: true,
        defaultModel: 'dummy',  // Будет заменен на 'openai-data' при наличии ключа
        models: ['dummy'],      // OpenAI агент будет добавлен автоматически
    },
    // ... остальная конфигурация
};
```

## Безопасность

### Рекомендации по безопасности

1. **Никогда не коммитьте API ключи** в систему контроля версий
2. **Используйте .env файлы** для локальной разработки
3. **Настройте переменные окружения** на продакшн сервере
4. **Ограничьте права API ключа** в консоли OpenAI
5. **Регулярно меняйте API ключи**

### .gitignore настройки

Убедитесь, что в `.gitignore` присутствует:
```gitignore
.env
```

## Troubleshooting

### Агент не работает

1. Проверьте, что `OPENAI_API_KEY` установлен:
```bash
echo $OPENAI_API_KEY
```

2. Проверьте логи при запуске:
```bash
npm run dev:no-seed
```

Ищите сообщение:
```
[fixture] OpenAI data agent successfully registered with ID: openai-data
```

3. Убедитесь, что файл `.env` загружается корректно (должно быть сообщение от dotenv):
```
[dotenv@17.2.2] injecting env (1) from .env
```

### Ошибки API

- **401 Unauthorized**: Проверьте правильность API ключа
- **429 Too Many Requests**: Превышен лимит запросов, проверьте квоту
- **500 Internal Server Error**: Проблемы с OpenAI API, попробуйте позже

## Использование

После настройки OpenAI агент будет доступен в интерфейсе AI-ассистента и сможет:

1. Отвечать на вопросы о данных в системе
2. Выполнять поиск по моделям
3. Генерировать отчеты на основе данных
4. Помогать с анализом информации

## Пример использования

В интерфейсе AI-ассистента можно задать вопросы вроде:
- "Покажи все записи из модели Example"
- "Найди пользователей с именем John"
- "Сколько категорий создано за последний месяц?"

Агент автоматически запросит нужные данные и предоставит ответ на естественном языке.